---
// src/pages/garden-mgmt/bookings.astro
---

<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Booking Management - BG Bouquet</title>

	<!-- Prevent search engine indexing - CRITICAL SECURITY -->
	<meta name="robots" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
	<meta name="googlebot" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
	<meta name="bingbot" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
	<meta name="slurp" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
	<meta name="duckduckbot" content="noindex, nofollow, noarchive, nosnippet, noimageindex">

	<!-- Prevent caching -->
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
	<meta http-equiv="Pragma" content="no-cache">
	<meta http-equiv="Expires" content="0">

	<link rel="icon" type="image/svg+xml" href="/favicon.svg">
	<link rel="stylesheet" href="/styles/admin.css">
</head>
<body>
	<!-- Login Form (shown initially) -->
	<div id="login-container" class="login-container">
		<div class="login-form">
			<h2>Admin Access</h2>
			<div id="login-error" class="error" style="display: none;"></div>
			<form id="login-form">
				<div class="form-group">
					<label for="admin-password">Password:</label>
					<input type="password" id="admin-password" required>
				</div>
				<button type="submit" class="btn btn-primary">Login</button>
			</form>
		</div>
	</div>

	<!-- Main Admin Interface (hidden initially) -->
	<div id="admin-interface" style="display: none;">
		<div class="header">
			<div class="header-content">
				<h1>BG Bouquet Admin</h1>
				<div class="header-actions">
					<a href="/garden-mgmt/admin" class="btn btn-secondary">Schedule Settings</a>
					<button id="logout-btn" class="logout-btn">Logout</button>
				</div>
			</div>
		</div>

		<div class="container">
			<!-- Dashboard Navigation -->
			<div class="dashboard-nav">
				<div class="time-filters">
					<button class="time-filter active" data-period="upcoming" title="Today and future bookings">Upcoming</button>
					<button class="time-filter" data-period="today">Today</button>
					<button class="time-filter" data-period="week">This Week</button>
					<button class="time-filter" data-period="month">This Month</button>
					<button class="time-filter" data-period="all">All Bookings</button>
					<button class="time-filter past-filter" data-period="past" title="Past bookings (read-only)">Past Bookings</button>
				</div>

				<div class="status-filters">
					<button class="status-filter active" data-status="confirmed" title="Active confirmed bookings">Active</button>
					<button class="status-filter" data-status="cancelled" title="Cancelled bookings">Cancelled</button>
					<button class="status-filter" data-status="all" title="All bookings regardless of status">All Status</button>
				</div>
				<div class="payment-filters">
					<span class="filter-label">Payment:</span>
					<button class="payment-filter active" data-payment="all">All</button>
					<button class="payment-filter" data-payment="pay_on_arrival">Pay on Arrival</button>
					<button class="payment-filter" data-payment="online">Paid Online</button>
				</div>
			</div>

			<!-- Summary Cards -->
			<div class="summary-cards">
				<div class="summary-card">
					<div class="summary-value" id="total-bookings">-</div>
					<div class="summary-label">Total Bookings</div>
				</div>
				<div class="summary-card">
					<div class="summary-value" id="pending-payment">-</div>
					<div class="summary-label">Pending Payment</div>
				</div>
				<div class="summary-card">
					<div class="summary-value" id="paid-bookings">-</div>
					<div class="summary-label">Paid</div>
				</div>
			</div>

			<!-- Advanced Date Range Filter (shown only for "All Bookings" view) -->
			<div class="date-range-filter" id="date-range-filter" style="display: none;">
				<div class="date-range-header">
					<span class="date-range-label">Date Range:</span>
					<button class="date-range-display" id="date-range-display">
						<span id="date-range-text">All Time</span>
						<span class="date-range-icon">üìÖ</span>
					</button>
				</div>

				<!-- Date Range Picker Dropdown -->
				<div class="date-picker-dropdown" id="date-picker-dropdown">
					<div class="date-picker-content">
						<div class="preset-ranges">
							<h4>Quick Ranges</h4>
							<button class="preset-range" data-range="last7">Last 7 days</button>
							<button class="preset-range" data-range="last30">Last 30 days</button>
							<button class="preset-range" data-range="last90">Last 3 months</button>
							<button class="preset-range" data-range="last365">Last year</button>
							<button class="preset-range" data-range="ytd">Year to date</button>
							<button class="preset-range active" data-range="all">All time</button>
						</div>
						<div class="custom-range">
							<h4>Custom Range</h4>
							<div class="date-inputs">
								<div class="date-input-group">
									<label for="start-date">From:</label>
									<input type="date" id="start-date" class="date-input">
								</div>
								<div class="date-input-group">
									<label for="end-date">To:</label>
									<input type="date" id="end-date" class="date-input">
								</div>
							</div>
						</div>
						<div class="date-picker-actions">
							<button class="btn btn-secondary" id="cancel-date-range">Cancel</button>
							<button class="btn btn-primary" id="apply-date-range">Apply</button>
						</div>
					</div>
				</div>
			</div>

			<!-- Search and Controls -->
			<div class="controls">
				<div class="controls-row">
					<div class="form-group">
						<label for="search-input">Search:</label>
						<input type="text" id="search-input" placeholder="Name, email, phone, or booking reference...">
					</div>
					<div class="form-group">
						<label>&nbsp;</label>
						<button id="search-btn" class="btn btn-primary">Search</button>
					</div>
					<div class="form-group">
						<label>&nbsp;</label>
						<button id="refresh-btn" class="btn btn-secondary">Refresh</button>
					</div>
					<div class="bulk-actions" id="bulk-actions" style="display: none;">
						<button id="bulk-mark-paid" class="btn btn-success btn-small">Mark Selected as Paid</button>
					</div>
				</div>
			</div>

			<div class="bookings-table">
				<div class="table-header">
					<div class="table-header-content">
						<h2>Booking Management</h2>
					</div>
				</div>

				<div id="loading" class="loading">
					<p>Loading bookings...</p>
				</div>

				<div id="error-container" style="display: none;"></div>

				<!-- Past bookings info banner -->
				<div id="past-bookings-info" class="info-banner" style="display: none;">
					<div class="info-content">
						<span class="info-icon">‚ÑπÔ∏è</span>
						<span class="info-text">Viewing past bookings - these cannot be cancelled or rescheduled</span>
					</div>
				</div>

				<div id="bookings-container" style="display: none;">
					<div class="column-headers">
						<div>Customer</div>
						<div>Reference</div>
						<div>Date & Time</div>
						<div>Amount</div>
						<div>Payment</div>
						<div>Status</div>
						<div>Actions</div>
					</div>
					<div id="bookings-grid" class="bookings-grid">
						<!-- Cards will be inserted here -->
					</div>
				</div>

				<div id="pagination" class="pagination" style="display: none;">
				</div>
			</div>
		</div>
	</div>



	<script>
		// Global variables
		let adminToken: string | null = null;
		let currentPage = 0;
		let currentFilters = {
			status: 'confirmed', // Default to active bookings
			search: '',
			period: 'upcoming', // Default to upcoming bookings (today and future)
			payment: 'all', // Default to all payment types
			dateRange: null as { start: string; end: string } | null // Custom date range for "all" view
		};
		const pageSize = 20;

		// DOM elements
		const loginContainer = document.getElementById('login-container') as HTMLElement;
		const adminInterface = document.getElementById('admin-interface') as HTMLElement;
		const loginForm = document.getElementById('login-form') as HTMLFormElement;
		const loginError = document.getElementById('login-error') as HTMLElement;
		const adminPassword = document.getElementById('admin-password') as HTMLInputElement;
		const logoutBtn = document.getElementById('logout-btn') as HTMLButtonElement;
		const searchInput = document.getElementById('search-input') as HTMLInputElement;
		const searchBtn = document.getElementById('search-btn') as HTMLButtonElement;
		const refreshBtn = document.getElementById('refresh-btn') as HTMLButtonElement;

		// Dashboard elements
		const timeFilters = document.querySelectorAll('.time-filter');
		const statusFilters = document.querySelectorAll('.status-filter');
		const paymentFilters = document.querySelectorAll('.payment-filter');
		const totalBookingsEl = document.getElementById('total-bookings') as HTMLElement;
		const pendingPaymentEl = document.getElementById('pending-payment') as HTMLElement;
		const paidBookingsEl = document.getElementById('paid-bookings') as HTMLElement;

		// Date range elements
		const dateRangeFilter = document.getElementById('date-range-filter') as HTMLElement;
		const dateRangeDisplay = document.getElementById('date-range-display') as HTMLButtonElement;
		const dateRangeText = document.getElementById('date-range-text') as HTMLElement;
		const datePickerDropdown = document.getElementById('date-picker-dropdown') as HTMLElement;
		const presetRanges = document.querySelectorAll('.preset-range');
		const startDateInput = document.getElementById('start-date') as HTMLInputElement;
		const endDateInput = document.getElementById('end-date') as HTMLInputElement;
		const applyDateRangeBtn = document.getElementById('apply-date-range') as HTMLButtonElement;
		const cancelDateRangeBtn = document.getElementById('cancel-date-range') as HTMLButtonElement;
		const loading = document.getElementById('loading') as HTMLElement;
		const errorContainer = document.getElementById('error-container') as HTMLElement;
		const bookingsContainer = document.getElementById('bookings-container') as HTMLElement;
		const bookingsGrid = document.getElementById('bookings-grid') as HTMLElement;
		const pagination = document.getElementById('pagination') as HTMLElement;
		const pastBookingsInfo = document.getElementById('past-bookings-info') as HTMLElement;

		// Event listeners
		if (loginForm) loginForm.addEventListener('submit', handleLogin);
		if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
		if (searchBtn) searchBtn.addEventListener('click', handleSearch);
		if (refreshBtn) refreshBtn.addEventListener('click', () => loadBookings());
		if (searchInput) {
			searchInput.addEventListener('keypress', (e: KeyboardEvent) => {
				if (e.key === 'Enter') handleSearch();
			});
		}

		// Dashboard filter listeners
		timeFilters.forEach(filter => {
			filter.addEventListener('click', handleTimeFilter);
		});

		statusFilters.forEach(filter => {
			filter.addEventListener('click', handleStatusFilter);
		});

		paymentFilters.forEach(filter => {
			filter.addEventListener('click', handlePaymentFilter);
		});

		// Date range listeners
		if (dateRangeDisplay) dateRangeDisplay.addEventListener('click', toggleDatePicker);
		if (applyDateRangeBtn) applyDateRangeBtn.addEventListener('click', applyDateRange);
		if (cancelDateRangeBtn) cancelDateRangeBtn.addEventListener('click', closeDatePicker);

		presetRanges.forEach(range => {
			range.addEventListener('click', handlePresetRange);
		});

		// Login handler
		async function handleLogin(e: Event): Promise<void> {
			e.preventDefault();

			if (!adminPassword) return;

			const password = adminPassword.value;
			if (!password) return;

			try {
				// Test authentication by making a request to admin API
				const response = await fetch('/api/garden-mgmt/bookings?limit=1', {
					headers: {
						'Authorization': `Bearer ${password}`
					}
				});

				if (response.ok) {
					adminToken = password;
					if (loginContainer) loginContainer.style.display = 'none';
					if (adminInterface) adminInterface.style.display = 'block';
					loadBookings();
				} else {
					showLoginError('Invalid password');
				}
			} catch (error) {
				showLoginError('Login failed. Please try again.');
			}
		}

		// Logout handler
		function handleLogout(): void {
			adminToken = null;
			if (adminInterface) adminInterface.style.display = 'none';
			if (loginContainer) loginContainer.style.display = 'flex';
			if (adminPassword) adminPassword.value = '';
			if (loginError) loginError.style.display = 'none';
		}

		// Show login error
		function showLoginError(message: string): void {
			if (loginError) {
				loginError.textContent = message;
				loginError.style.display = 'block';
			}
		}

		// Search handler
		function handleSearch(): void {
			if (searchInput) currentFilters.search = searchInput.value.trim();
			currentPage = 0;
			loadBookings();
		}

		// Time filter handler
		function handleTimeFilter(event: Event): void {
			const target = event.target as HTMLButtonElement;
			const period = target.dataset.period;
			if (!period) return;

			// Update active state
			timeFilters.forEach(f => f.classList.remove('active'));
			target.classList.add('active');

			// Show/hide date range filter based on selection
			if (dateRangeFilter) {
				if (period === 'all') {
					dateRangeFilter.style.display = 'block';
				} else {
					dateRangeFilter.style.display = 'none';
					closeDatePicker(); // Close picker if open
					currentFilters.dateRange = null; // Reset custom range
				}
			}

			// Show/hide past bookings info banner
			if (pastBookingsInfo) {
				if (period === 'past') {
					pastBookingsInfo.style.display = 'block';
				} else {
					pastBookingsInfo.style.display = 'none';
				}
			}

			// Update filter and reload
			currentFilters.period = period;
			currentPage = 0;
			loadBookings();
		}

		// Status filter handler
		function handleStatusFilter(event: Event): void {
			const target = event.target as HTMLButtonElement;
			const status = target.dataset.status;
			if (!status) return;

			// Update active state
			statusFilters.forEach(f => f.classList.remove('active'));
			target.classList.add('active');

			// Update filter and reload
			currentFilters.status = status;
			currentPage = 0;
			loadBookings();
		}

		// Payment filter handler
		function handlePaymentFilter(event: Event): void {
			const target = event.target as HTMLButtonElement;
			const payment = target.dataset.payment;
			if (!payment) return;

			// Update active state
			paymentFilters.forEach(f => f.classList.remove('active'));
			target.classList.add('active');

			// Update filter and reload
			currentFilters.payment = payment;
			currentPage = 0;
			loadBookings();
		}

		// Date range functions
		function toggleDatePicker(): void {
			if (datePickerDropdown) {
				datePickerDropdown.classList.toggle('show');
			}
		}

		function closeDatePicker(): void {
			if (datePickerDropdown) {
				datePickerDropdown.classList.remove('show');
			}
		}

		function handlePresetRange(event: Event): void {
			const target = event.target as HTMLButtonElement;
			const range = target.dataset.range;
			if (!range) return;

			// Update active state
			presetRanges.forEach(r => r.classList.remove('active'));
			target.classList.add('active');

			// Calculate date range
			const now = new Date();
			const mtOffset = now.getTimezoneOffset() + (7 * 60); // Mountain Time
			const mtNow = new Date(now.getTime() - (mtOffset * 60 * 1000));

			let startDate: Date;
			let endDate = new Date(mtNow);

			switch (range) {
				case 'last7':
					startDate = new Date(mtNow);
					startDate.setDate(mtNow.getDate() - 7);
					break;
				case 'last30':
					startDate = new Date(mtNow);
					startDate.setDate(mtNow.getDate() - 30);
					break;
				case 'last90':
					startDate = new Date(mtNow);
					startDate.setDate(mtNow.getDate() - 90);
					break;
				case 'last365':
					startDate = new Date(mtNow);
					startDate.setFullYear(mtNow.getFullYear() - 1);
					break;
				case 'ytd':
					startDate = new Date(mtNow.getFullYear(), 0, 1);
					break;
				default: // 'all'
					currentFilters.dateRange = null;
					updateDateRangeDisplay('All Time');
					closeDatePicker();
					currentPage = 0;
					loadBookings();
					return;
			}

			// Set the date range
			currentFilters.dateRange = {
				start: startDate.toISOString().split('T')[0],
				end: endDate.toISOString().split('T')[0]
			};

			// Update inputs
			if (startDateInput) startDateInput.value = currentFilters.dateRange.start;
			if (endDateInput) endDateInput.value = currentFilters.dateRange.end;

			// Update display and reload
			updateDateRangeDisplay(target.textContent || 'Custom Range');
			closeDatePicker();
			currentPage = 0;
			loadBookings();
		}

		function applyDateRange(): void {
			if (!startDateInput || !endDateInput) return;

			const startDate = startDateInput.value;
			const endDate = endDateInput.value;

			if (!startDate || !endDate) {
				alert('Please select both start and end dates');
				return;
			}

			if (startDate > endDate) {
				alert('Start date must be before end date');
				return;
			}

			// Set custom date range
			currentFilters.dateRange = { start: startDate, end: endDate };

			// Update preset selection
			presetRanges.forEach(r => r.classList.remove('active'));

			// Update display
			const startFormatted = new Date(startDate).toLocaleDateString();
			const endFormatted = new Date(endDate).toLocaleDateString();
			updateDateRangeDisplay(`${startFormatted} - ${endFormatted}`);

			closeDatePicker();
			currentPage = 0;
			loadBookings();
		}

		function updateDateRangeDisplay(text: string): void {
			if (dateRangeText) {
				dateRangeText.textContent = text;
			}
		}

		// Load bookings
		async function loadBookings(): Promise<void> {
			if (!adminToken) return;

			try {
				if (loading) loading.style.display = 'block';
				if (errorContainer) errorContainer.style.display = 'none';
				if (bookingsContainer) bookingsContainer.style.display = 'none';

				const params = new URLSearchParams({
					limit: pageSize.toString(),
					offset: (currentPage * pageSize).toString(),
					status: currentFilters.status,
					period: currentFilters.period,
					payment: currentFilters.payment
				});

				if (currentFilters.search) {
					params.append('search', currentFilters.search);
				}

				// Add custom date range if set
				if (currentFilters.dateRange) {
					params.append('startDate', currentFilters.dateRange.start);
					params.append('endDate', currentFilters.dateRange.end);
				}

				const response = await fetch(`/api/garden-mgmt/bookings?${params}`, {
					headers: {
						'Authorization': `Bearer ${adminToken}`
					}
				});

				if (!response.ok) {
					throw new Error('Failed to load bookings');
				}

				const data = await response.json();
				renderBookings(data.bookings);
				renderPagination(data.total);
				updateSummaryCards(data.summary || {});

			} catch (error) {
				console.error('Error loading bookings:', error);
				showError('Failed to load bookings. Please try again.');
			} finally {
				if (loading) loading.style.display = 'none';
			}
		}

		// Update summary cards
		function updateSummaryCards(summary: any): void {
			if (totalBookingsEl) totalBookingsEl.textContent = summary.total || '0';
			if (pendingPaymentEl) pendingPaymentEl.textContent = summary.pending || '0';
			if (paidBookingsEl) paidBookingsEl.textContent = summary.paid || '0';
		}

		// Render bookings cards
		function renderBookings(bookings: any[]): void {
			if (!bookingsGrid) return;

			bookingsGrid.innerHTML = '';

			if (bookings.length === 0) {
				bookingsGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #6c757d; font-style: italic;">No bookings found</div>';
			} else {
				bookings.forEach((booking: any) => {
					const card = createBookingCard(booking);
					if (bookingsGrid) bookingsGrid.appendChild(card);
				});
			}

			if (bookingsContainer) bookingsContainer.style.display = 'block';
		}

		// Create booking card with professional horizontal layout
		function createBookingCard(booking: any): HTMLElement {
			const card = document.createElement('div');

			// Check if booking is in the past
			const [year, month, day] = booking.date.split('-').map(Number);
			const visitDate = new Date(year, month - 1, day); // month is 0-indexed
			const today = new Date();
			today.setHours(0, 0, 0, 0); // Reset time to start of day for comparison
			const isPastBooking = visitDate < today;

			// Set card classes based on booking status and date
			card.className = `booking-card ${isPastBooking ? 'past-booking' : ''}`;

			// Status should only be 'Active' or 'Cancelled' - refunds are separate
			let statusClass, statusText;
			if (booking.status === 'cancelled') {
				statusClass = 'status-cancelled';
				statusText = 'Cancelled';
			} else if (isPastBooking) {
				statusClass = 'status-past';
				statusText = 'Past';
			} else {
				statusClass = 'status-active';
				statusText = 'Active';
			}

			// Format date - parse as local date to avoid timezone issues
			const bookingDate = visitDate.toLocaleDateString('en-US', {
				weekday: 'short',
				month: 'short',
				day: 'numeric'
			});

			// Get customer initials for avatar
			const initials = booking.full_name
				.split(' ')
				.map((name: string) => name.charAt(0))
				.join('')
				.toUpperCase()
				.substring(0, 2);

			card.innerHTML = `
				<div class="card-content">
					<!-- Customer Info -->
					<div class="customer-section">
						<div class="customer-avatar">${initials}</div>
						<div class="customer-info">
							<div class="customer-name">${booking.full_name}</div>
							<div class="customer-contact">${booking.email}</div>
						</div>
					</div>

					<!-- Booking Reference -->
					<div class="booking-reference-section">
						${booking.booking_reference ?
							`<div class="booking-reference">${booking.booking_reference}</div>` :
							`<div class="booking-reference-empty">No reference</div>`
						}
					</div>

					<!-- Booking Date & Time -->
					<div class="booking-datetime">
						<div class="datetime-main">${bookingDate}</div>
						<div class="datetime-time">${booking.time}</div>
						${booking.reschedule_count > 0 ? `<div class="reschedule-note">Rescheduled ${booking.reschedule_count}x</div>` : ''}
					</div>

					<!-- Amount & Bouquets -->
					<div class="booking-amount">
						<div class="amount-main">$${booking.total_amount}</div>
						<div class="amount-details">
							${booking.number_of_bouquets} ${booking.number_of_bouquets === 1 ? 'bouquet' : 'bouquets'}
							${booking.number_of_visitor_passes > 0 ? `, ${booking.number_of_visitor_passes} visitor ${booking.number_of_visitor_passes === 1 ? 'pass' : 'passes'}` : ''}
						</div>
						${booking.admin_refund_amount ? `<div class="refund-note">Refunded: $${booking.admin_refund_amount}</div>` : ''}
					</div>

					<!-- Payment Status -->
					<div class="payment-status">
						<div class="payment-main ${booking.payment_status === 'paid' ? 'status-paid' : 'status-pending'}">
							${booking.payment_status === 'paid' ? 'PAID' : 'UNPAID'}
						</div>
						<div class="payment-method">
							${booking.payment_method === 'pay_on_arrival' ? 'Pay on arrival' : 'Online'}
						</div>
					</div>

					<!-- Status Badge -->
					<div class="booking-status">
						<span class="status-badge ${statusClass}">${statusText}</span>
					</div>

					<!-- Actions Menu -->
					<div class="booking-actions">
						<div class="actions-menu">
							<button class="actions-trigger" onclick="toggleActionsMenu('${booking.id}')"></button>
							<div class="actions-dropdown" id="actions-${booking.id}">
								${booking.status === 'confirmed' && booking.payment_method === 'pay_on_arrival' && !isPastBooking ?
									`<button class="${booking.payment_status === 'paid' ? 'warning' : 'success'}" onclick="showPaymentToggleModal('${booking.id}', '${booking.payment_status}', '${booking.full_name}'); hideActionsMenu('${booking.id}')">
										${booking.payment_status === 'paid' ? 'Mark Unpaid' : 'Mark Paid'}
									</button>`
									: ''
								}
								${booking.status === 'confirmed' && !isPastBooking ? `<button onclick="rescheduleBooking('${booking.id}'); hideActionsMenu('${booking.id}')">Reschedule</button>` : ''}
								${booking.status === 'confirmed' && booking.payment_status === 'paid' && !isPastBooking ?
									`<button onclick="documentRefund('${booking.id}'); hideActionsMenu('${booking.id}')">Document Refund</button>`
									: ''
								}
								<button onclick="viewBookingHistory('${booking.id}'); hideActionsMenu('${booking.id}')">
									View History
								</button>
								${booking.status === 'confirmed' && !isPastBooking ? `<button class="danger" onclick="cancelBooking('${booking.id}'); hideActionsMenu('${booking.id}')">Cancel Booking</button>` : ''}
								${isPastBooking && booking.status === 'confirmed' ? `<div class="past-booking-notice">Past bookings cannot be modified</div>` : ''}
							</div>
						</div>
					</div>
				</div>
			`;

			return card;
		}

		// Render pagination
		function renderPagination(total: number): void {
			if (!pagination) return;

			const totalPages = Math.ceil(total / pageSize);
			pagination.innerHTML = '';

			if (totalPages <= 1) {
				pagination.style.display = 'none';
				return;
			}

			// Previous button
			const prevBtn = document.createElement('button');
			prevBtn.textContent = 'Previous';
			prevBtn.disabled = currentPage === 0;
			prevBtn.onclick = () => {
				if (currentPage > 0) {
					currentPage--;
					loadBookings();
				}
			};
			pagination.appendChild(prevBtn);

			// Page numbers
			for (let i = 0; i < totalPages; i++) {
				const pageBtn = document.createElement('button');
				pageBtn.textContent = (i + 1).toString();
				pageBtn.className = i === currentPage ? 'active' : '';
				pageBtn.onclick = () => {
					currentPage = i;
					loadBookings();
				};
				pagination.appendChild(pageBtn);
			}

			// Next button
			const nextBtn = document.createElement('button');
			nextBtn.textContent = 'Next';
			nextBtn.disabled = currentPage >= totalPages - 1;
			nextBtn.onclick = () => {
				if (currentPage < totalPages - 1) {
					currentPage++;
					loadBookings();
				}
			};
			pagination.appendChild(nextBtn);

			pagination.style.display = 'flex';
		}

		// Show error
		function showError(message: string): void {
			if (errorContainer) {
				errorContainer.innerHTML = `<div class="error">${message}</div>`;
				errorContainer.style.display = 'block';
			}
		}

		// Admin action functions - make them global so onclick can access them
		(window as any).cancelBooking = async function(bookingId: string): Promise<void> {
			const reason = prompt('Reason for cancellation (optional):');
			if (reason === null) return; // User cancelled

			const adminUser = prompt('Your admin name:');
			if (!adminUser) {
				alert('Admin name is required');
				return;
			}

			if (!confirm('Are you sure you want to cancel this booking?')) return;

			try {
				const response = await fetch('/api/garden-mgmt/cancel-booking', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${adminToken}`
					},
					body: JSON.stringify({
						bookingId,
						reason,
						adminUser,
						notifyCustomer: true
					})
				});

				const data = await response.json();

				if (response.ok) {
					alert('Booking cancelled successfully');
					loadBookings(); // Refresh the list
				} else {
					alert(`Failed to cancel booking: ${data.error}`);
				}
			} catch (error) {
				alert('Error cancelling booking. Please try again.');
			}
		};

		(window as any).rescheduleBooking = async function(bookingId: string): Promise<void> {
			const newDate = prompt('New date (YYYY-MM-DD):');
			if (!newDate) return;

			// Validate date format
			const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
			if (!dateRegex.test(newDate)) {
				alert('Invalid date format. Please use YYYY-MM-DD');
				return;
			}

			// Check if date is not in the past
			const newDateObj = new Date(newDate);
			const today = new Date();
			today.setHours(0, 0, 0, 0);
			if (newDateObj < today) {
				alert('Cannot reschedule to past dates');
				return;
			}

			const newTime = prompt('New time (e.g., 10:00 AM):');
			if (!newTime) return;

			const reason = prompt('Reason for reschedule (optional):');
			if (reason === null) return; // User cancelled

			const adminUser = prompt('Your admin name:');
			if (!adminUser) {
				alert('Admin name is required');
				return;
			}

			const notifyCustomer = confirm('Send confirmation email to customer?');

			if (!confirm(`Reschedule booking to ${newDate} at ${newTime}?`)) return;

			try {
				const response = await fetch('/api/garden-mgmt/reschedule-booking', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${adminToken}`
					},
					body: JSON.stringify({
						bookingId,
						newDate,
						newTime,
						reason,
						adminUser,
						notifyCustomer
					})
				});

				const data = await response.json();

				if (response.ok) {
					alert('Booking rescheduled successfully');
					loadBookings(); // Refresh the list
				} else {
					alert(`Failed to reschedule booking: ${data.error}`);
				}
			} catch (error) {
				alert('Error rescheduling booking. Please try again.');
			}
		};

		(window as any).showPaymentToggleModal = function(bookingId: string, currentStatus: string, customerName: string): void {
			const newStatus = currentStatus === 'paid' ? 'pending' : 'paid';
			const action = newStatus === 'paid' ? 'mark as paid' : 'mark as unpaid';

			// Populate modal
			const customerNameEl = document.getElementById('paymentCustomerName');
			const actionEl = document.getElementById('paymentAction');
			const bookingIdEl = document.getElementById('paymentBookingId') as HTMLInputElement;
			const statusEl = document.getElementById('paymentNewStatus') as HTMLInputElement;
			const modalEl = document.getElementById('paymentToggleModal');

			if (customerNameEl) customerNameEl.textContent = customerName;
			if (actionEl) actionEl.textContent = `${action.charAt(0).toUpperCase() + action.slice(1)} this booking`;
			if (bookingIdEl) bookingIdEl.value = bookingId;
			if (statusEl) statusEl.value = newStatus;
			if (modalEl) modalEl.style.display = 'block';
		};

		(window as any).closePaymentToggleModal = function(): void {
			const modalEl = document.getElementById('paymentToggleModal');
			const adminNameEl = document.getElementById('paymentAdminName') as HTMLInputElement;

			if (modalEl) modalEl.style.display = 'none';
			if (adminNameEl) adminNameEl.value = '';
		};

		(window as any).confirmPaymentToggle = async function(): Promise<void> {
			const bookingIdEl = document.getElementById('paymentBookingId') as HTMLInputElement;
			const statusEl = document.getElementById('paymentNewStatus') as HTMLInputElement;
			const adminUserEl = document.getElementById('paymentAdminName') as HTMLInputElement;

			if (!bookingIdEl || !statusEl || !adminUserEl) {
				alert('Required form elements not found');
				return;
			}

			const bookingId = bookingIdEl.value;
			const newStatus = statusEl.value;
			const adminUser = adminUserEl.value.trim();

			// Validation
			if (!adminUser) {
				alert('Please enter your name for record keeping');
				return;
			}

			try {
				const response = await fetch('/api/garden-mgmt/toggle-payment', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${adminToken}`
					},
					body: JSON.stringify({
						bookingId,
						newStatus,
						adminUser
					})
				});

				const data = await response.json();

				if (response.ok) {
					(window as any).closePaymentToggleModal();
					loadBookings(); // Refresh the list
				} else {
					alert(`Failed to update payment status: ${data.error}`);
				}
			} catch (error) {
				console.error('Error updating payment status:', error);
				alert('Error updating payment status. Please try again.');
			}
		};

		(window as any).documentRefund = async function(bookingId: string): Promise<void> {
			try {
				// Fetch current refund data from the API
				const response = await fetch(`/api/garden-mgmt/document-refund?bookingId=${bookingId}`, {
					headers: {
						'Authorization': `Bearer ${adminToken}`
					}
				});

				if (!response.ok) {
					throw new Error('Failed to fetch refund data');
				}

				const data = await response.json();
				const booking = data.booking;
				const existingRefund = booking.refund;

				// Populate modal with booking information
				const customerNameEl = document.getElementById('refundCustomerName');
				const bookingDetailsEl = document.getElementById('refundBookingDetails');
				const originalAmountEl = document.getElementById('refundOriginalAmount');
				const maxAmountEl = document.getElementById('refundMaxAmount');
				const bookingIdEl = document.getElementById('refundBookingId') as HTMLInputElement;
				const refundAmountEl = document.getElementById('refundAmount') as HTMLInputElement;

				if (customerNameEl) customerNameEl.textContent = booking.customerName;
				if (bookingDetailsEl) bookingDetailsEl.textContent = `${booking.date} at ${booking.time}`;
				if (originalAmountEl) originalAmountEl.textContent = booking.totalAmount.toFixed(2);
				if (maxAmountEl) maxAmountEl.textContent = booking.totalAmount.toFixed(2);
				if (bookingIdEl) bookingIdEl.value = bookingId;

				// Set max amount validation
				if (refundAmountEl) refundAmountEl.max = booking.totalAmount.toString();

				// Update modal title based on whether refund exists
				const modalTitle = document.querySelector('#refundModal .modal-header h3');
				if (existingRefund) {
					if (modalTitle) modalTitle.textContent = 'Update Refund Documentation';

					// Pre-populate form with existing refund data
					const amountEl = document.getElementById('refundAmount') as HTMLInputElement;
					const methodEl = document.getElementById('refundMethod') as HTMLSelectElement;
					const notesEl = document.getElementById('refundNotes') as HTMLTextAreaElement;
					const adminNameEl = document.getElementById('refundAdminName') as HTMLInputElement;

					if (amountEl) amountEl.value = existingRefund.amount.toString();
					if (methodEl) methodEl.value = existingRefund.method;
					if (notesEl) notesEl.value = existingRefund.notes || '';
					if (adminNameEl) adminNameEl.value = existingRefund.processedBy || '';
				} else {
					if (modalTitle) modalTitle.textContent = 'Document Refund';

					// Clear form for new refund
					const formEl = document.getElementById('refundForm') as HTMLFormElement;
					const bookingIdInputEl = document.getElementById('refundBookingId') as HTMLInputElement;

					if (formEl) formEl.reset();
					if (bookingIdInputEl) bookingIdInputEl.value = bookingId;
				}

				// Show modal
				const modalEl = document.getElementById('refundModal');
				if (modalEl) modalEl.style.display = 'block';

			} catch (error) {
				console.error('Error loading refund data:', error);
				alert('Error loading refund information. Please try again.');
			}
		};

		(window as any).closeRefundModal = function(): void {
			const modalEl = document.getElementById('refundModal');
			if (modalEl) modalEl.style.display = 'none';
		};

		(window as any).submitRefund = async function(): Promise<void> {
			const bookingIdEl = document.getElementById('refundBookingId') as HTMLInputElement;
			const refundAmountEl = document.getElementById('refundAmount') as HTMLInputElement;
			const refundMethodEl = document.getElementById('refundMethod') as HTMLSelectElement;
			const refundNotesEl = document.getElementById('refundNotes') as HTMLTextAreaElement;
			const adminUserEl = document.getElementById('refundAdminName') as HTMLInputElement;

			if (!bookingIdEl || !refundAmountEl || !refundMethodEl || !refundNotesEl || !adminUserEl) {
				alert('Required form elements not found');
				return;
			}

			const bookingId = bookingIdEl.value;
			const refundAmount = parseFloat(refundAmountEl.value);
			const refundMethod = refundMethodEl.value;
			const refundNotes = refundNotesEl.value;
			const adminUser = adminUserEl.value;
			const maxAmount = parseFloat(refundAmountEl.max);

			// Validation
			if (!refundAmount || refundAmount <= 0) {
				alert('Please enter a valid refund amount');
				return;
			}

			if (refundAmount > maxAmount) {
				alert(`Refund amount cannot exceed $${maxAmount.toFixed(2)}`);
				return;
			}

			if (!refundMethod) {
				alert('Please select a refund method');
				return;
			}

			if (!adminUser.trim()) {
				alert('Please enter your name for record keeping');
				return;
			}

			try {
				// First, get the current refund data to track changes
				const currentResponse = await fetch(`/api/garden-mgmt/document-refund?bookingId=${bookingId}`, {
					headers: {
						'Authorization': `Bearer ${adminToken}`
					}
				});

				let previousRefund = null;
				if (currentResponse.ok) {
					const currentData = await currentResponse.json();
					previousRefund = currentData.booking.refund;
				}

				// Submit the refund update
				const response = await fetch('/api/garden-mgmt/document-refund', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${adminToken}`
					},
					body: JSON.stringify({
						bookingId,
						refundAmount,
						refundMethod,
						refundNotes,
						adminUser,
						previousRefund // Include previous data for history tracking
					})
				});

				const data = await response.json();

				if (response.ok) {
					(window as any).closeRefundModal();
					loadBookings(); // Refresh the list
				} else {
					alert(`Failed to document refund: ${data.error}`);
				}
			} catch (error) {
				console.error('Error documenting refund:', error);
				alert('Error documenting refund. Please try again.');
			}
		};

		// Close modals when clicking outside
		window.onclick = function(event: Event): void {
			const refundModal = document.getElementById('refundModal');
			const paymentModal = document.getElementById('paymentToggleModal');

			if (event.target === refundModal) {
				(window as any).closeRefundModal();
			}

			if (event.target === paymentModal) {
				(window as any).closePaymentToggleModal();
			}
		};

		(window as any).viewBookingHistory = async function(bookingId: string): Promise<void> {
			try {
				// Fetch booking history from the database
				const response = await fetch(`/api/garden-mgmt/booking-history?bookingId=${bookingId}`, {
					headers: {
						'Authorization': `Bearer ${adminToken}`
					}
				});

				if (!response.ok) {
					throw new Error('Failed to fetch booking history');
				}

				const data = await response.json();

				// Populate modal header info
				const customerNameEl = document.getElementById('historyCustomerName');
				const bookingDetailsEl = document.getElementById('historyBookingDetails');

				if (customerNameEl) customerNameEl.textContent = data.booking.customerName;

				// Format the booking date and time in a more readable format
				if (bookingDetailsEl) {
					const bookingDate = new Date(data.booking.currentDate + 'T00:00:00');
					const formattedDate = bookingDate.toLocaleDateString('en-US', {
						weekday: 'short',
						month: 'short',
						day: 'numeric'
					});
					bookingDetailsEl.textContent = `${formattedDate}  ${data.booking.currentTime}`;
				}

				const historyContent = document.getElementById('historyContent');

				if (data.actions && data.actions.length > 0) {
					// Create history items
					let historyHTML = '';

					data.actions.forEach((action: any) => {
						const date = new Date(action.action_timestamp).toLocaleDateString('en-US', {
							weekday: 'short',
							year: 'numeric',
							month: 'short',
							day: 'numeric'
						});
						const time = new Date(action.action_timestamp).toLocaleTimeString('en-US', {
							hour: 'numeric',
							minute: '2-digit',
							hour12: true
						});

						// Format action type, with special handling for different action types
						let actionType: string;
						let actionIcon: string = '';
						let actionClass: string = '';

						if (action.action_type === 'booking_created') {
							actionType = 'Booking Created';
							actionIcon = 'üìÖ';
							actionClass = 'history-creation';
						} else if (action.reason && action.reason.includes('Payment marked as')) {
							// Extract the payment action from the reason
							if (action.reason.includes('Payment marked as PAID')) {
								actionType = 'Payment Marked Paid';
								actionIcon = 'üí≥';
								actionClass = 'history-payment-paid';
							} else if (action.reason.includes('Payment marked as UNPAID')) {
								actionType = 'Payment Marked Unpaid';
								actionIcon = 'üí≥';
								actionClass = 'history-payment-unpaid';
							} else {
								actionType = action.action_type.replace(/_/g, ' ').replace(/\b\w/g, (l: string) => l.toUpperCase());
								actionIcon = 'üí≥';
								actionClass = 'history-payment';
							}
						} else if (action.reason && action.reason.includes('Refund document')) {
							// Extract the refund action from the reason
							if (action.reason.includes('Refund documented -')) {
								actionType = 'Refund Documented';
								actionIcon = 'üí∞';
								actionClass = 'history-refund';
							} else if (action.reason.includes('Refund document updated')) {
								actionType = 'Refund Updated';
								actionIcon = 'üí∞';
								actionClass = 'history-refund';
							} else {
								actionType = action.action_type.replace(/_/g, ' ').replace(/\b\w/g, (l: string) => l.toUpperCase());
								actionIcon = 'üí∞';
								actionClass = 'history-refund';
							}
						} else if (action.action_type === 'cancellation') {
							actionType = 'Booking Cancelled';
							actionIcon = '‚ùå';
							actionClass = 'history-cancellation';
						} else if (action.action_type === 'admin_cancellation') {
							actionType = 'Booking Cancelled by Admin';
							actionIcon = 'üõë';
							actionClass = 'history-admin-cancellation';
						} else if (action.action_type.includes('reschedule')) {
							actionType = 'Booking Rescheduled';
							actionIcon = 'üîÑ';
							actionClass = 'history-reschedule';
						} else {
							actionType = action.action_type.replace(/_/g, ' ').replace(/\b\w/g, (l: string) => l.toUpperCase());
							actionIcon = 'üìù';
							actionClass = 'history-other';
						}

						historyHTML += `
							<div class="history-item ${actionClass}">
								<div class="history-header">
									<span class="history-icon">${actionIcon}</span>
									<div class="history-main">
										<span class="history-action">${actionType}</span>
										<span class="history-date">${date} at ${time}</span>
									</div>
								</div>
								<div class="history-details">
									${action.reason && action.action_type !== 'booking_created' ? `<div class="history-reason">${action.reason.replace('Reason: ', '')}</div>` : ''}
									<div class="history-performer">
										${action.performed_by_admin ? `Admin: ${action.performed_by_admin}` : 'Customer'}
									</div>
									${action.action_type.includes('reschedule') ? `
										<div class="history-reschedule">
											<strong>From:</strong> ${action.original_date} at ${action.original_time}<br>
											<strong>To:</strong> ${action.new_date} at ${action.new_time}
										</div>
									` : ''}
								</div>
							</div>
						`;
					});

					// Check if we only have the creation event
					const hasNonCreationActions = data.actions.some((action: any) => action.action_type !== 'booking_created');

					if (!hasNonCreationActions) {
						historyHTML += `
							<div class="history-no-activity">
								<p><em>No additional activity on this booking.</em></p>
							</div>
						`;
					}

					if (historyContent) historyContent.innerHTML = historyHTML;
				} else {
					// This case should not happen anymore since we always include creation event
					if (historyContent) {
						historyContent.innerHTML = `
							<div class="no-history">
								<p>Unable to load booking history.</p>
								<p><small>Please try again or contact support.</small></p>
							</div>
						`;
					}
				}

				// Show the modal
				const modalEl = document.getElementById('historyModal');
				if (modalEl) modalEl.style.display = 'block';

			} catch (error) {
				console.error('Error fetching booking history:', error);
				alert('Error loading booking history. Please try again.');
			}
		};

		(window as any).closeHistoryModal = function(): void {
			const modalEl = document.getElementById('historyModal');
			if (modalEl) modalEl.style.display = 'none';
		};

		// Actions menu functions
		(window as any).toggleActionsMenu = function(bookingId: string): void {
			const dropdown = document.getElementById(`actions-${bookingId}`);
			if (!dropdown) return;

			// Close all other dropdowns first and remove active class from cards
			document.querySelectorAll('.actions-dropdown.show').forEach(el => {
				if (el.id !== `actions-${bookingId}`) {
					el.classList.remove('show');
					const card = el.closest('.booking-card');
					if (card) card.classList.remove('dropdown-active');
				}
			});

			// Toggle current dropdown
			dropdown.classList.toggle('show');
			const card = dropdown.closest('.booking-card');
			if (card) {
				card.classList.toggle('dropdown-active', dropdown.classList.contains('show'));
			}
		};

		(window as any).hideActionsMenu = function(bookingId: string): void {
			const dropdown = document.getElementById(`actions-${bookingId}`);
			if (dropdown) {
				dropdown.classList.remove('show');
				const card = dropdown.closest('.booking-card');
				if (card) card.classList.remove('dropdown-active');
			}
		};

		// Close dropdowns when clicking outside
		document.addEventListener('click', function(event: Event): void {
			const target = event.target as HTMLElement;

			// Close action menus
			if (!target.closest('.actions-menu')) {
				document.querySelectorAll('.actions-dropdown.show').forEach(el => {
					el.classList.remove('show');
					const card = el.closest('.booking-card');
					if (card) card.classList.remove('dropdown-active');
				});
			}

			// Close date picker
			if (!target.closest('.date-range-filter')) {
				closeDatePicker();
			}
		});

		// Close history modal when clicking outside of it
		window.addEventListener('click', function(event: Event): void {
			const historyModal = document.getElementById('historyModal');
			if (event.target === historyModal) {
				(window as any).closeHistoryModal();
			}
		});




	</script>

	<!-- Refund Modal -->
	<div id="refundModal" class="modal">
		<div class="modal-content">
			<div class="modal-header">
				<h3>Document Refund</h3>
				<span class="close" onclick="closeRefundModal()">&times;</span>
			</div>
			<div class="modal-body">
				<div class="booking-info">
					<p><strong>Customer:</strong> <span id="refundCustomerName"></span></p>
					<p><strong>Booking:</strong> <span id="refundBookingDetails"></span></p>
					<p><strong>Original Amount:</strong> $<span id="refundOriginalAmount"></span></p>
				</div>

				<form id="refundForm">
					<input type="hidden" id="refundBookingId" />

					<div class="form-group">
						<label for="refundAmount">Amount refunded to customer:</label>
						<input type="number" id="refundAmount" step="0.01" min="0" required />
						<small class="form-help">Maximum: $<span id="refundMaxAmount"></span></small>
					</div>

					<div class="form-group">
						<label for="refundMethod">How was the refund issued:</label>
						<select id="refundMethod" required>
							<option value="">Select method...</option>
							<option value="Cash">Cash</option>
							<option value="E-transfer">E-transfer</option>
							<option value="Credit card reversal">Credit card reversal</option>
						</select>
					</div>

					<div class="form-group">
						<label for="refundNotes">Notes about this refund:</label>
						<textarea id="refundNotes" rows="3" placeholder="e.g., Reason for refund, special circumstances"></textarea>
					</div>

					<div class="form-group">
						<label for="refundAdminName">Your name (for record keeping):</label>
						<input type="text" id="refundAdminName" required />
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" onclick="closeRefundModal()">Cancel</button>
				<button type="button" class="btn btn-primary" onclick="submitRefund()">Document Refund</button>
			</div>
		</div>
	</div>

	<!-- Booking History Modal -->
	<div id="historyModal" class="modal">
		<div class="modal-content">
			<div class="modal-header">
				<h3>Booking History</h3>
				<span class="close" onclick="closeHistoryModal()">&times;</span>
			</div>
			<div class="modal-body">
				<div class="booking-info">
					<p><strong>Customer:</strong> <span id="historyCustomerName"></span></p>
					<p><strong>Booking:</strong> <span id="historyBookingDetails"></span></p>
				</div>

				<div id="historyContent">
					<!-- History items will be inserted here -->
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" onclick="closeHistoryModal()">Close</button>
			</div>
		</div>
	</div>

	<!-- Payment Toggle Confirmation Modal -->
	<div id="paymentToggleModal" class="modal">
		<div class="modal-content">
			<div class="modal-header">
				<h3>Confirm Payment Status Change</h3>
				<span class="close" onclick="closePaymentToggleModal()">&times;</span>
			</div>
			<div class="modal-body">
				<div class="booking-info">
					<p><strong>Customer:</strong> <span id="paymentCustomerName"></span></p>
					<p><strong>Action:</strong> <span id="paymentAction"></span></p>
				</div>

				<div class="form-group">
					<label for="paymentAdminName">Your name (for record keeping):</label>
					<input type="text" id="paymentAdminName" required placeholder="Enter your admin name" />
				</div>

				<input type="hidden" id="paymentBookingId" />
				<input type="hidden" id="paymentNewStatus" />
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" onclick="closePaymentToggleModal()">Cancel</button>
				<button type="button" class="btn btn-primary" onclick="confirmPaymentToggle()">Confirm</button>
			</div>
		</div>
	</div>
</body>
</html>
